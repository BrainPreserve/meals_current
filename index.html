<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meal Generator — Login + BTMA Integration</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1020; color:#e5e7eb; margin:0; }
      .wrap { max-width: 1040px; margin: 24px auto; padding: 0 16px; }
      .card { background:#0e162d; border:1px solid #223055; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.3); padding:16px 18px; margin-bottom:16px; }
      h1, h2 { margin:0 0 8px; }
      a { color:#93c5fd; }
      button { background:#2563eb; color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; }
      iframe { background:#fff; border-radius:12px; }
      .muted { color:#9fb2d2; }
      .hidden { display:none; }
      .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
      input, textarea { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #3b4870; background:#0c1530; color:#e5e7eb; }
      label { font-size:14px; color:#c5d3f1; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Brain‑Healthy Meal Generator</h1>
        <div class="muted">Sign in once (magic link). Your progress is tracked across devices by your email‑based ID.</div>
        <div class="row" id="authRow">
          <button id="loginBtn">Log in / Sign up</button>
          <button id="logoutBtn" class="hidden">Log out</button>
          <div id="whoami" class="muted"></div>
        </div>
      </div>

      <div id="app" class="hidden">
        <!-- Embedded BTMA Panel -->
        <div class="card">
          <h2>BTMA Biomarker Panel (Embedded)</h2>
          <div class="muted" style="margin-bottom:10px;">
            Enter biomarkers and run Pro / AI Coaching / AI Analysis without leaving the page.
          </div>
          <p>
            <a id="btmaLink" href="#" target="_blank" rel="noopener">Open BTMA in a new tab</a>
          </p>
          <iframe id="btmaFrame" title="BTMA Embedded"
            style="width:100%;height:960px;border:0;display:block;"
            loading="eager"
            referrerpolicy="no-referrer"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox">
          </iframe>
        </div>

        <!-- Minimal demo: Send to BTMA -->
        <div class="card">
          <h2>Save Latest Meals/Tables to BTMA</h2>
          <div class="row">
            <div style="flex:1;min-width:280px;">
              <label>Meals HTML</label>
              <textarea id="meals" rows="5" placeholder="<div>Example recipe...</div>"></textarea>
            </div>
            <div style="flex:1;min-width:280px;">
              <label>Nutrition Tables HTML</label>
              <textarea id="tables" rows="5" placeholder="<table>Example nutrition table...</table>"></textarea>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div style="flex:1;min-width:200px;">
              <label>Recipe count</label>
              <input id="rcount" type="number" value="1" min="0">
            </div>
            <div style="flex:1;min-width:200px;">
              <label>&nbsp;</label>
              <button id="saveBtn">Send to BTMA</button>
            </div>
          </div>
          <div id="saveStatus" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>

    <script>
      // --- Config: set once ---
      const BTMA_EXEC_URL = "https://script.google.com/macros/s/AKfycbzDg-xTVoejpfXtQSG2vAPvaEZuMvba0oLq48uss8Z57_omNh3Dd6vr4WTUo3p7dRtDyg/exec"; // e.g., https://script.google.com/macros/s/.../exec
      const SEND_FN_URL = "/.netlify/functions/send-to-btma";  // Netlify function path

      // Utility: SHA-256 hash of email -> hex string for client_id
      async function hashEmail(email) {
        const enc = new TextEncoder().encode(email.trim().toLowerCase());
        const buf = await crypto.subtle.digest('SHA-256', enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 24); // shorter id
      }

      // Netlify Identity
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const whoami = document.getElementById('whoami');
      const app = document.getElementById('app');

      function showUser(user) {
        if (!user) {
          whoami.textContent = '';
          app.classList.add('hidden');
          loginBtn.classList.remove('hidden');
          logoutBtn.classList.add('hidden');
          return;
        }
        whoami.textContent = `Signed in as ${user.email}`;
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        app.classList.remove('hidden');
      }

      netlifyIdentity.on('init', user => showUser(user));
      netlifyIdentity.on('login', user => { showUser(user); netlifyIdentity.close(); initAfterLogin(user); });
      netlifyIdentity.on('logout', () => { showUser(null); location.reload(); });

      loginBtn.addEventListener('click', () => netlifyIdentity.open('login'));
      logoutBtn.addEventListener('click', () => netlifyIdentity.logout());

      // After login: compute client_id and wire BTMA + send-to-btma
      async function initAfterLogin(user) {
        const email = user && user.email;
        if (!email) return;
        const cid = await hashEmail(email);

        // Wire BTMA iframe + link
        const frame = document.getElementById('btmaFrame');
        const link = document.getElementById('btmaLink');
        const url = `${BTMA_EXEC_URL}?mode=embedded&cid=${encodeURIComponent(cid)}`;
        frame.src = url;
        link.href = `${BTMA_EXEC_URL}?cid=${encodeURIComponent(cid)}`;

        // Wire Send to BTMA (posts meals/tables/recipe_count + client_id)
        const btn = document.getElementById('saveBtn');
        const meals = document.getElementById('meals');
        const tables = document.getElementById('tables');
        const rcount = document.getElementById('rcount');
        const status = document.getElementById('saveStatus');

        btn.onclick = async () => {
          status.textContent = 'Saving…';
          try {
            const resp = await fetch(SEND_FN_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                client_id: cid,
                meals_html: meals.value || '',
                tables_html: tables.value || '',
                recipe_count: rcount.value || ''
              })
            });
            const txt = await resp.text();
            status.textContent = `Saved (HTTP ${resp.status}).`;
          } catch (e) {
            status.textContent = 'Error: ' + e.message;
          }
        };
      }

      // Initialize (loads current user if already logged in)
      netlifyIdentity.init();
    </script>
  </body>
</html>
